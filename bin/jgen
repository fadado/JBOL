#!/bin/bash
#
# Generates the JSON schema for an instance document
#

# Bash options
set -o errexit -o noglob -o nounset -o pipefail
shopt -s expand_aliases

# jgen version
declare -r VERSION='0.1'

# This script name
declare -r SELF="${0##*/}"

# JQ script
declare -r JQ="${0}.jq"

# JBOL modules path
declare -r JBOL='-L/usr/local/share/jbol'

# Print text on screen
alias print='echo 1>&2 -e'

# Show help
function help {
    cat 1>&2 <<EOF
${SELF} - generates a JSON schema
Usage: ${SELF} [options] [file]

${SELF} generates a JSON schema for an instance document read from a file or
the standard input.

Options:
    -h, --help              Show this help
    -c, --compact           Compact output
    -k, --sort-keys         Sort output keys 
    -r, --required          Add the 'required' keyword
    -a, --verbose-array     Add array constraints
    -n, --verbose-number    Add number constraints
    -o, --verbose-object    Add object constraints
    -s, --verbose-string    Add string constraints
EOF
    exit $(( $# == 0 ))
}

# Print version and exit
function version {
    print "$SELF $VERSION"
    exit 0
}

# Print usage message and exit
function usage {
    print "Unknown option: $1\n"
    print "Usage: ${SELF} [-h | --help | -V]"
    print "Usage: ${SELF} [options] [file]"
    exit 1
}

# Entry point
function main {
    local required='false' compact='false' \
          vnumber='false' vstring='false' varray='false' vobject='false'
    local -i compact=0 skeys=0

    local opt
    while getopts :Vhacknors-: opt; do
        case $opt in
            V) version ;;
            h) help ;;
            a) varray='true' ;;
            c) compact=1 ;;
            k) skeys=1 ;;
            n) vnumber='true' ;;
            o) vobject='true' ;;
            r) required='true' ;;
            s) vstring='true' ;;
            -) case $OPTARG in
                   version) version ;;
                   help) help ;;
                   compact) compact=1 ;;
                   required) required='true' ;;
                   sort-keys) skeys=1 ;;
                   verbose-array) varray='true' ;;
                   verbose-number) vnumber='true' ;;
                   verbose-object) vobject='true' ;;
                   verbose-string) vstring='true' ;;
                   *) usage "--$OPTARG";;
                esac
                ;;
            ?) usage "-$OPTARG";;
        esac
    done

    shift $((OPTIND-1))

    local COMPACT='' SORT_KEYS=''
    local -a REQUIRED VARRAY VNUMBER VOBJECT VSTRING

    if ((compact)); then COMPACT="--compact-output"; fi
    if ((skeys)); then SORT_KEYS="--sort-keys"; fi

    VARRAY=('--argjson'   'opt_array_verbose'  $varray)
    VNUMBER=('--argjson'  'opt_number_verbose' $vnumber)
    VOBJECT=('--argjson'  'opt_object_verbose' $vobject)
    REQUIRED=('--argjson' 'opt_required'       $required)
    VSTRING=('--argjson'  'opt_string_verbose' $vstring)

    jq $JBOL \
        --from-file ${JQ}   \
        ${SORT_KEYS}        \
        ${COMPACT}          \
        "${REQUIRED[@]}"    \
        "${VARRAY[@]}"      \
        "${VNUMBER[@]}"     \
        "${VSTRING[@]}"     \
        "${VOBJECT[@]}"     \
        "$@"
}

# Call main and exit
main "$@"

exit

# vim:syntax=sh:ai:sw=4:ts=4:et
